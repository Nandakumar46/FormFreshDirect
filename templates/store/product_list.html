{% extends 'base.html' %}
{% block title %}Products{% endblock %}
{% block content %}
    <h2>Our Fresh Fruits & Vegitables</h2>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <p class="message message-{{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
    <div class="product-grid">
        {% for product in products %}
            <div class="product-card">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% endif %}
                <h3>{{ product.name }}</h3>
                <p class="product-price">â‚¹{{ product.price|floatformat:2 }}</p>
                <p>{{ product.description|truncatewords:20 }}</p>
                <p class="product-farmer">Sold by: {{ product.farmer.get_full_name|default:product.farmer.username }}</p>

                {% if user.is_authenticated and user.profile.user_type == 'CLIENT' %}
                <form action="{% url 'store:add_to_cart' product.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Add to Cart</button>
                </form>
                {% endif %}

                {% if user.is_authenticated and product.farmer == user %}
                    <div class="farmer-actions">
                        <a href="{% url 'store:edit_product' product.id %}" class="btn btn-secondary">Edit</a>

                        <form action="{% url 'store:unlist_product' product.id %}" method="post" onsubmit="return confirm('Are you sure you want to unlist this product? It will no longer be visible to customers.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Unlist</button>
                        </form>
                    </div>
                {% endif %}
            </div>
        {% empty %}
            <p>No products are available at the moment.</p>
        {% endfor %}
    </div>
{% endblock %}